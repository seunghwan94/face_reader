<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>AI ê´€ìƒ ë¶„ì„ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
      --bg: #0f172a;
      --card: #111827;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.15);
      --border: #1f2937;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --danger: #f97373;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 24px;
    }
    .app {
      width: 100%;
      max-width: 1200px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      gap: 18px;
    }
    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; }
    }
    .card {
      background: radial-gradient(circle at top left, #111827 0, #020617 60%);
      border-radius: 16px;
      padding: 18px 18px 20px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 14px;
    }
    .title {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .subtitle {
      font-size: 13px;
      color: var(--text-sub);
    }
    .badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      background: rgba(15,23,42,0.85);
      color: var(--accent);
    }

    .upload-zone {
      border: 1px dashed rgba(148,163,184,0.6);
      border-radius: 14px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.09), transparent 55%);
    }
    .upload-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .upload-label {
      font-size: 13px;
      color: var(--text-sub);
    }
    .file-input-wrap {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: rgba(15,23,42,0.92);
      border-radius: 999px;
      border: 1px solid rgba(31,41,55,0.9);
      font-size: 13px;
      cursor: pointer;
    }
    .file-input-wrap span {
      color: var(--text-sub);
    }
    input[type=file] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }
    .filename {
      font-size: 12px;
      color: var(--text-sub);
      max-width: 280px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
      align-items: center;
    }
    .select {
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid rgba(31,41,55,0.9);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
    }
    .select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.35);
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    button {
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 13px;
      padding: 7px 14px;
      cursor: pointer;
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.08s ease;
    }
    button.primary {
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      border-color: rgba(148,163,184,0.4);
      color: white;
      font-weight: 500;
    }
    button.secondary {
      border-color: rgba(55,65,81,0.9);
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
      transform: none !important;
    }
    button:not(:disabled):hover {
      transform: translateY(-1px);
      border-color: var(--accent);
    }

    .status {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-sub);
      min-height: 16px;
    }
    .status strong { color: var(--accent); }
    .status.error { color: var(--danger); }

    .preview-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    @media (max-width: 900px) {
      .preview-grid { grid-template-columns: 1fr; }
    }
    .preview-card {
      background: rgba(15,23,42,0.9);
      border-radius: 12px;
      border: 1px solid rgba(31,41,55,0.9);
      padding: 8px;
    }
    .preview-title {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .img-wrapper {
      position: relative;
      width: 100%;
      padding-top: 75%;
      border-radius: 10px;
      overflow: hidden;
      background: radial-gradient(circle at top, #111827 0, #020617 60%);
    }
    .img-wrapper img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .metrics {
      margin-top: 12px;
      max-height: 260px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(15,23,42,0.85);
    }
    .metrics-header {
      font-size: 13px;
      padding: 8px 10px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .metrics-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .metrics-table th,
    .metrics-table td {
      padding: 4px 10px;
      text-align: left;
      border-bottom: 1px dashed rgba(31,41,55,0.8);
    }
    .metrics-table th {
      color: var(--text-sub);
      font-weight: 500;
      width: 45%;
    }
    .metrics-table tr:nth-child(2n) {
      background: rgba(15,23,42,0.8);
    }

    .interp-card {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .interp-body {
      margin-top: 8px;
      border-radius: 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.9);
      padding: 10px;
      flex: 1;
      min-height: 220px;
      max-height: 430px;
      overflow: auto;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .hint {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ì¢Œì¸¡: ì…ë ¥ / ë¯¸ë¦¬ë³´ê¸° / ì§€í‘œ -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="title">AI ê´€ìƒ ë¶„ì„ê¸° (í´ë¼ì´ì–¸íŠ¸)</div>
          <div class="subtitle">ì–¼êµ´ ì´ë¯¸ì§€ í•œ ì¥ìœ¼ë¡œ ì§€í‘œÂ·ì„ ë¼ì¸Â·ê´€ìƒ í•´ì„ê¹Œì§€</div>
        </div>
        <span class="badge">ë°±ì—”ë“œ: Flask /face API</span>
      </div>

      <!-- ì—…ë¡œë“œ ì˜ì—­ -->
      <div class="upload-zone">
        <div class="upload-row">
          <div class="upload-label">1. ê´€ìƒ ë¶„ì„í•  ì–¼êµ´ ì´ë¯¸ì§€ë¥¼ ì˜¬ë ¤ì£¼ì„¸ìš” (ì •ë©´, jpg/png, 2MB ì´í•˜)</div>
        </div>
        <div class="upload-row">
          <label class="file-input-wrap">
            <span>ğŸ“· ì´ë¯¸ì§€ ì„ íƒ</span>
            <input type="file" id="imageInput" accept="image/jpeg,image/png" />
          </label>
          <div id="filename" class="filename">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</div>
        </div>

        <div class="options">
          <label class="upload-label">LLM ì„ íƒ:</label>
          <select id="llmSelect" class="select">
            <option value="gpt">GPT (gpt-4o-mini)</option>
            <option value="gemini">Gemini (2.5-flash)</option>
          </select>
        </div>

        <div class="btn-row">
          <button id="btnMetrics" class="secondary">
            ğŸ“ ì§€í‘œë§Œ ë³´ê¸°
          </button>
          <button id="btnAnnotate" class="secondary">
            âœï¸ ì„ ë¼ì¸ í¬í•¨
          </button>
          <button id="btnInterpret" class="primary">
            ğŸ”® ê´€ìƒ í•´ì„ê¹Œì§€
          </button>
        </div>
        <div id="status" class="status"></div>
        <div class="hint">â€» ê´€ìƒ í•´ì„ ë²„íŠ¼ì€ ë°±ì—”ë“œì—ì„œ OpenAI / Gemini API í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ ì‘ë™í•©ë‹ˆë‹¤.</div>
      </div>

      <!-- ì´ë¯¸ì§€ í”„ë¦¬ë·° -->
      <div class="preview-grid">
        <div class="preview-card">
          <div class="preview-title">
            <span>ì›ë³¸ ì´ë¯¸ì§€</span>
          </div>
          <div class="img-wrapper">
            <img id="originalPreview" alt="ì›ë³¸ ë¯¸ë¦¬ë³´ê¸°" />
          </div>
        </div>
        <div class="preview-card">
          <div class="preview-title">
            <span>ì„ ë¼ì¸/ì§€í‘œ ì‹œê°í™” ì´ë¯¸ì§€</span>
          </div>
          <div class="img-wrapper">
            <img id="annotatedPreview" alt="ì„ ë¼ì¸ ë¯¸ë¦¬ë³´ê¸°" />
          </div>
        </div>
      </div>

      <!-- ì§€í‘œ -->
      <div class="metrics" id="metricsBox" style="display:none;">
        <div class="metrics-header">
          <span>ì–¼êµ´ ì •ëŸ‰ ì§€í‘œ (ìƒëŒ€ì ì¸ ìˆ˜ì¹˜)</span>
          <span style="font-size:11px;color:var(--text-sub);">ê°’ì´ í¬ë‹¤ê³  ë¬´ì¡°ê±´ ì¢‹ê±°ë‚˜ ë‚˜ìœ ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤.</span>
        </div>
        <table class="metrics-table" id="metricsTable">
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ìš°ì¸¡: ê´€ìƒ í•´ì„ í…ìŠ¤íŠ¸ -->
    <section class="card interp-card">
      <div class="card-header">
        <div>
          <div class="title">ê´€ìƒ í•´ì„ ê²°ê³¼</div>
          <div class="subtitle">GPT / Geminiê°€ ì–¼êµ´ ì§€í‘œë¥¼ ë°”íƒ•ìœ¼ë¡œ í’€ì–´ë‚¸ í•œêµ­ì‹ ê´€ìƒ ë¦¬í¬íŠ¸</div>
        </div>
      </div>
      <div id="interpretationBox" class="interp-body">
        ì•„ì§ ë¶„ì„ì´ ìˆ˜í–‰ë˜ì§€ ì•Šì•˜ì–´ìš”.  
        ì™¼ìª½ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•œ ë’¤,  
        <ê´€ìƒ í•´ì„ê¹Œì§€> ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.
      </div>
      <div class="hint">
        â€» ì‹¤ì œ ì ê´˜ì²˜ëŸ¼ ë‹¨ì •í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì–¼êµ´ ë¹„ìœ¨Â·í˜•ìƒÂ·ì¢Œìš°ëŒ€ì¹­ ë“±ì„ ë°”íƒ•ìœ¼ë¡œ
        â€œê·¸ëŸ´ ê°€ëŠ¥ì„±ì´ ë†’ì€ ê²½í–¥â€ì„ ì´ì•¼ê¸°í•˜ëŠ” í˜•ì‹ì…ë‹ˆë‹¤.
      </div>
    </section>
  </div>

  <script>
    const imageInput   = document.getElementById('imageInput');
    const filenameSpan = document.getElementById('filename');
    const statusEl     = document.getElementById('status');
    const originalImg  = document.getElementById('originalPreview');
    const annotatedImg = document.getElementById('annotatedPreview');
    const llmSelect    = document.getElementById('llmSelect');

    const metricsBox   = document.getElementById('metricsBox');
    const metricsTableBody = document.querySelector('#metricsTable tbody');
    const interpretationBox = document.getElementById('interpretationBox');

    const btnMetrics   = document.getElementById('btnMetrics');
    const btnAnnotate  = document.getElementById('btnAnnotate');
    const btnInterpret = document.getElementById('btnInterpret');

    const API_BASE = (() => {
        // file:// ë¡œ ì—´ì—ˆìœ¼ë©´ ë°±ì—”ë“œ(ë¡œì»¬ Flask)ë¡œ ê³ ì •
        if (location.protocol === 'file:') return 'http://127.0.0.1:5000';
        // ë™ì¼ ì˜¤ë¦¬ì§„ì—ì„œ ì„œë¹™í•˜ëŠ” ê²½ìš° ê·¸ëŒ€ë¡œ ìƒëŒ€ê²½ë¡œ ì‚¬ìš©
        return '';
    })();

    const metricLabels = {
      face_width: "ì–¼êµ´ ê°€ë¡œí­",
      face_height: "ì–¼êµ´ ì„¸ë¡œê¸¸ì´",
      eye_distance: "ë‘ ëˆˆ ì‚¬ì´ ê±°ë¦¬",
      left_eye_width: "ì™¼ìª½ ëˆˆ ê°€ë¡œ",
      right_eye_width: "ì˜¤ë¥¸ìª½ ëˆˆ ê°€ë¡œ",
      left_eye_height: "ì™¼ìª½ ëˆˆ ì„¸ë¡œ",
      right_eye_height: "ì˜¤ë¥¸ìª½ ëˆˆ ì„¸ë¡œ",
      nose_length: "ì½” ê¸¸ì´",
      nose_width: "ì½” í­",
      mouth_width: "ì…ìˆ  ê°€ë¡œ",
      mouth_height: "ì…ìˆ  ì„¸ë¡œ",
      eye_to_mouth: "ëˆˆ-ì… ì¤‘ì‹¬ ê°„ ê±°ë¦¬",
      eye_left_to_chin: "ì™¼ëˆˆ-í„± ì¤‘ì•™ ê±°ë¦¬",
      eye_right_to_chin: "ì˜¤ë¥¸ëˆˆ-í„± ì¤‘ì•™ ê±°ë¦¬",
      nose_to_mouth: "ì½”-ì… ê±°ë¦¬",
      nose_to_chin: "ì½”-í„± ê±°ë¦¬",
      jaw_width: "í„± ê°€ë¡œ í­",
      jaw_length: "í„± ë¼ì¸ ê¸¸ì´",
      mouth_tilt_angle: "ì…ê¼¬ë¦¬ ê¸°ìš¸ê¸° ê°ë„(Â°)",
      left_eb_to_eye_dist: "ì™¼ ëˆˆì¹-ëˆˆ ì‚¬ì´",
      right_eb_to_eye_dist: "ì˜¤ë¥¸ ëˆˆì¹-ëˆˆ ì‚¬ì´"
    };

    function setStatus(message, isError=false) {
      statusEl.textContent = message || "";
      statusEl.classList.toggle("error", isError);
    }

    function setLoading(isLoading, label) {
      const buttons = [btnMetrics, btnAnnotate, btnInterpret];
      buttons.forEach(btn => btn.disabled = isLoading);
      if (isLoading) {
        setStatus(label || "ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...");
      } else {
        if (!statusEl.classList.contains("error")) {
          setStatus("");
        }
      }
    }

    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (!file) {
        filenameSpan.textContent = "ì„ íƒëœ íŒŒì¼ ì—†ìŒ";
        originalImg.src = "";
        annotatedImg.src = "";
        return;
      }
      filenameSpan.textContent = file.name;

      // ë¯¸ë¦¬ë³´ê¸°
      const reader = new FileReader();
      reader.onload = e => {
        originalImg.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    async function callApi(endpoint, extraFormFields = {}) {
      const file = imageInput.files[0];
      if (!file) {
        setStatus("ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", true);
        alert("ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        throw new Error("no-image");
      }
      const form = new FormData();
      form.append("image", file);
      for (const [k, v] of Object.entries(extraFormFields)) {
        form.append(k, v);
      }

      const resp = await fetch(API_BASE + "/api/v1/" + endpoint, {
        method: "POST",
        body: form
      });

      if (!resp.ok) {
        let msg = "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        try {
          const data = await resp.json();
          if (data && data.error) msg = data.error;
        } catch (_) {}
        setStatus(msg, true);
        throw new Error(msg);
      }
      const data = await resp.json();
      return data;
    }

    function renderMetrics(metrics) {
      if (!metrics || typeof metrics !== "object") {
        metricsBox.style.display = "none";
        return;
      }
      metricsBox.style.display = "block";
      metricsTableBody.innerHTML = "";

      const entries = Object.entries(metrics).sort((a,b) => a[0].localeCompare(b[0]));
      for (const [key, value] of entries) {
        if (typeof value !== "number") continue;
        const tr = document.createElement("tr");
        const th = document.createElement("th");
        const td = document.createElement("td");

        th.textContent = metricLabels[key] || key;
        td.textContent = value.toFixed(2);

        tr.appendChild(th);
        tr.appendChild(td);
        metricsTableBody.appendChild(tr);
      }
    }

    // ë²„íŠ¼ ì´ë²¤íŠ¸
    btnMetrics.addEventListener("click", async () => {
      setLoading(true, "ì–¼êµ´ ì§€í‘œ ì¶”ì¶œ ì¤‘...");
      try {
        const data = await callApi("metrics");
        renderMetrics(data);          // /metricsëŠ” metrics dict ìì²´ë¥¼ ë°˜í™˜
        setStatus("ì§€í‘œ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      } catch (err) {
        if (err.message !== "no-image") {
          console.error(err);
        }
      } finally {
        setLoading(false);
      }
    });

    btnAnnotate.addEventListener("click", async () => {
      setLoading(true, "ì„ ë¼ì¸ ë° ì§€í‘œ ì‹œê°í™” ì¤‘...");
      try {
        const data = await callApi("annotate");
        if (data.annotated_image) {
          annotatedImg.src = data.annotated_image; // ì´ë¯¸ data:image/jpeg;base64,... í˜•ì‹
        }
        renderMetrics(data.metrics);
        setStatus("ì„ ë¼ì¸ ë° ì§€í‘œ ì‹œê°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      } catch (err) {
        if (err.message !== "no-image") {
          console.error(err);
        }
      } finally {
        setLoading(false);
      }
    });

    btnInterpret.addEventListener("click", async () => {
      const llm = llmSelect.value || "gpt";
      setLoading(true, `ê´€ìƒ í•´ì„(${llm.toUpperCase()}) ìƒì„± ì¤‘...`);
      interpretationBox.textContent = "ê´€ìƒ í•´ì„ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ë³´í†µ ìˆ˜ ì´ˆ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤...";
      try {
        const data = await callApi("interpret", { llm });
        if (data.annotated_image) {
          annotatedImg.src = data.annotated_image;
        }
        renderMetrics(data.metrics);
        if (data.interpretation) {
          interpretationBox.textContent = data.interpretation;
        } else {
          interpretationBox.textContent = "ê´€ìƒ í•´ì„ í…ìŠ¤íŠ¸ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
        }
        setStatus("ê´€ìƒ í•´ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      } catch (err) {
        if (err.message === "no-image") {
          interpretationBox.textContent = "ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•œ ë’¤, ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        } else {
          interpretationBox.textContent = "ê´€ìƒ í•´ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†” ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
          console.error(err);
        }
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
